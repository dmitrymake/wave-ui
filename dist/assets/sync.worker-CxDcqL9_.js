(function(){"use strict";const p={NAME:"MoodePlayerDB",STORE_NAME:"music",VERSION:3},N={open(){return new Promise((f,d)=>{const s=indexedDB.open(p.NAME,p.VERSION);s.onupgradeneeded=i=>{const u=i.target.result,a=i.target.transaction;let l;u.objectStoreNames.contains(p.STORE_NAME)?l=a.objectStore(p.STORE_NAME):l=u.createObjectStore(p.STORE_NAME,{keyPath:"file"}),l.indexNames.contains("artist")||l.createIndex("artist","artist",{unique:!1}),l.indexNames.contains("album")||l.createIndex("album","album",{unique:!1}),l.indexNames.contains("genre")||l.createIndex("genre","genre",{unique:!1}),l.indexNames.contains("album_artist")||l.createIndex("album_artist","album_artist",{unique:!1})},s.onsuccess=()=>f(s.result),s.onerror=()=>d(s.error)})},async clear(){const f=await this.open();return new Promise((d,s)=>{const i=f.transaction(p.STORE_NAME,"readwrite");i.objectStore(p.STORE_NAME).clear(),i.oncomplete=()=>d(),i.onerror=()=>s(i.error)})},async bulkAdd(f){const d=await this.open();return new Promise((s,i)=>{const u=d.transaction(p.STORE_NAME,"readwrite"),a=u.objectStore(p.STORE_NAME);f.forEach(l=>a.put(l)),u.oncomplete=()=>s(),u.onerror=()=>i(u.error)})},async getFilesMap(f){if(!f||f.length===0)return new Map;const d=await this.open();return new Promise(s=>{const u=d.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME),a=new Map;let l=0;f.forEach(o=>{const h=o.normalize("NFC").trim(),t=u.get(h);t.onsuccess=r=>{r.target.result&&a.set(o,r.target.result),l++,l===f.length&&s(a)},t.onerror=()=>{l++,l===f.length&&s(a)}})})},async getArtists(){const f=await this.open();return new Promise((d,s)=>{const u=f.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME),a=new Map,l=u.openCursor();l.onsuccess=o=>{const h=o.target.result;if(h){const t=h.value,r=t.album_artist||t.artist;r&&!a.has(r)&&a.set(r,{name:r,file:t.file,thumbHash:t.thumbHash}),h.continue()}else{const t=Array.from(a.values()).sort((r,n)=>r.name.localeCompare(n.name,void 0,{sensitivity:"base"}));d(t)}},l.onerror=()=>s(l.error)})},async getAlbums(){const f=await this.open();return new Promise((d,s)=>{const u=f.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("album"),a=[],l=u.openCursor(null,"nextunique");l.onsuccess=o=>{const h=o.target.result;if(h){const t=h.value;a.push({name:t.album,artist:t.album_artist||t.artist,file:t.file,thumbHash:t.thumbHash,qualityBadge:t.qualityBadge,year:t.year||0}),h.continue()}else d(a)},l.onerror=()=>s(l.error)})},async getArtistAlbums(f){if(!f)return[];const d=await this.open(),s=f.normalize("NFC").trim();return new Promise((i,u)=>{const l=d.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME),o=new Promise(t=>{l.indexNames.contains("album_artist")?l.index("album_artist").getAll(IDBKeyRange.only(s)).onsuccess=r=>t(r.target.result):t([])}),h=new Promise(t=>{l.index("artist").getAll(IDBKeyRange.only(s)).onsuccess=r=>t(r.target.result)});Promise.all([o,h]).then(([t,r])=>{const n=[...t,...r],e=[],c=new Set;n.forEach(g=>{c.has(g.album)||(c.add(g.album),e.push({name:g.album,artist:g.album_artist||g.artist,file:g.file,thumbHash:g.thumbHash,qualityBadge:g.qualityBadge,year:g.year||0}))}),i(e)}).catch(t=>u(t))})},async getAlbumTracks(f,d=null){const s=await this.open(),i=f.normalize("NFC").trim(),u=d?d.normalize("NFC").trim():null;return console.log(`[DB] getAlbumTracks called. Album: "${i}", FilterArtist: "${u}"`),new Promise((a,l)=>{const h=s.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("album"),t=IDBKeyRange.only(i),r=h.getAll(t);r.onsuccess=()=>{let n=r.result;if(console.log(`[DB] Found ${n.length} raw tracks for album "${i}"`),u){const e=n.length;n=n.filter(c=>{const g=(c.artist||"").normalize("NFC").trim(),m=(c.album_artist||"").normalize("NFC").trim();return g===u||m===u}),console.log(`[DB] After artist filter: ${n.length} tracks (Removed ${e-n.length})`)}else console.log("[DB] No artist filter provided. Returning all tracks.");n.sort((e,c)=>{const g=parseInt(e.disc||1),m=parseInt(c.disc||1);if(g!==m)return g-m;const y=parseInt(e.track||0),A=parseInt(c.track||0);return y-A}),a(n)},r.onerror=()=>l(r.error)})},async getGenres(){const f=await this.open();return new Promise((d,s)=>{const u=f.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("genre"),a=[],l=u.openKeyCursor(null,"nextunique");l.onsuccess=o=>{const h=o.target.result;h?(a.push(h.key),h.continue()):d(a)},l.onerror=()=>s(l.error)})},async getGenreTracks(f){const d=await this.open(),s=f.normalize("NFC").trim();return new Promise((i,u)=>{const o=d.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("genre").getAll(IDBKeyRange.only(s));o.onsuccess=()=>i(o.result),o.onerror=()=>u(o.error)})},async search(f){if(!f)return[];const d=f.toLowerCase().normalize("NFC").trim(),s=await this.open();return new Promise((i,u)=>{const l=s.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME),o=[],h=100,t=l.openCursor();t.onsuccess=r=>{const n=r.target.result;if(n){const e=n.value;if((e.title&&e.title.toLowerCase().includes(d)||e.artist&&e.artist.toLowerCase().includes(d)||e.album&&e.album.toLowerCase().includes(d)||e.album_artist&&e.album_artist.toLowerCase().includes(d))&&o.push(e),o.length>=h){i(o);return}n.continue()}else i(o)},t.onerror=()=>u(t.error)})}};function B(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}var S={exports:{}},b={exports:{}},T;function C(){return T||(T=1,(function(){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d={rotl:function(s,i){return s<<i|s>>>32-i},rotr:function(s,i){return s<<32-i|s>>>i},endian:function(s){if(s.constructor==Number)return d.rotl(s,8)&16711935|d.rotl(s,24)&4278255360;for(var i=0;i<s.length;i++)s[i]=d.endian(s[i]);return s},randomBytes:function(s){for(var i=[];s>0;s--)i.push(Math.floor(Math.random()*256));return i},bytesToWords:function(s){for(var i=[],u=0,a=0;u<s.length;u++,a+=8)i[a>>>5]|=s[u]<<24-a%32;return i},wordsToBytes:function(s){for(var i=[],u=0;u<s.length*32;u+=8)i.push(s[u>>>5]>>>24-u%32&255);return i},bytesToHex:function(s){for(var i=[],u=0;u<s.length;u++)i.push((s[u]>>>4).toString(16)),i.push((s[u]&15).toString(16));return i.join("")},hexToBytes:function(s){for(var i=[],u=0;u<s.length;u+=2)i.push(parseInt(s.substr(u,2),16));return i},bytesToBase64:function(s){for(var i=[],u=0;u<s.length;u+=3)for(var a=s[u]<<16|s[u+1]<<8|s[u+2],l=0;l<4;l++)u*8+l*6<=s.length*8?i.push(f.charAt(a>>>6*(3-l)&63)):i.push("=");return i.join("")},base64ToBytes:function(s){s=s.replace(/[^A-Z0-9+\/]/ig,"");for(var i=[],u=0,a=0;u<s.length;a=++u%4)a!=0&&i.push((f.indexOf(s.charAt(u-1))&Math.pow(2,-2*a+8)-1)<<a*2|f.indexOf(s.charAt(u))>>>6-a*2);return i}};b.exports=d})()),b.exports}var w,R;function v(){if(R)return w;R=1;var f={utf8:{stringToBytes:function(d){return f.bin.stringToBytes(unescape(encodeURIComponent(d)))},bytesToString:function(d){return decodeURIComponent(escape(f.bin.bytesToString(d)))}},bin:{stringToBytes:function(d){for(var s=[],i=0;i<d.length;i++)s.push(d.charCodeAt(i)&255);return s},bytesToString:function(d){for(var s=[],i=0;i<d.length;i++)s.push(String.fromCharCode(d[i]));return s.join("")}}};return w=f,w}var x,M;function I(){if(M)return x;M=1,x=function(s){return s!=null&&(f(s)||d(s)||!!s._isBuffer)};function f(s){return!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function d(s){return typeof s.readFloatLE=="function"&&typeof s.slice=="function"&&f(s.slice(0,0))}return x}var O;function q(){return O||(O=1,(function(){var f=C(),d=v().utf8,s=I(),i=v().bin,u=function(a,l){a.constructor==String?l&&l.encoding==="binary"?a=i.stringToBytes(a):a=d.stringToBytes(a):s(a)?a=Array.prototype.slice.call(a,0):!Array.isArray(a)&&a.constructor!==Uint8Array&&(a=a.toString());for(var o=f.bytesToWords(a),h=a.length*8,t=1732584193,r=-271733879,n=-1732584194,e=271733878,c=0;c<o.length;c++)o[c]=(o[c]<<8|o[c]>>>24)&16711935|(o[c]<<24|o[c]>>>8)&4278255360;o[h>>>5]|=128<<h%32,o[(h+64>>>9<<4)+14]=h;for(var g=u._ff,m=u._gg,y=u._hh,A=u._ii,c=0;c<o.length;c+=16){var _=t,D=r,H=n,j=e;t=g(t,r,n,e,o[c+0],7,-680876936),e=g(e,t,r,n,o[c+1],12,-389564586),n=g(n,e,t,r,o[c+2],17,606105819),r=g(r,n,e,t,o[c+3],22,-1044525330),t=g(t,r,n,e,o[c+4],7,-176418897),e=g(e,t,r,n,o[c+5],12,1200080426),n=g(n,e,t,r,o[c+6],17,-1473231341),r=g(r,n,e,t,o[c+7],22,-45705983),t=g(t,r,n,e,o[c+8],7,1770035416),e=g(e,t,r,n,o[c+9],12,-1958414417),n=g(n,e,t,r,o[c+10],17,-42063),r=g(r,n,e,t,o[c+11],22,-1990404162),t=g(t,r,n,e,o[c+12],7,1804603682),e=g(e,t,r,n,o[c+13],12,-40341101),n=g(n,e,t,r,o[c+14],17,-1502002290),r=g(r,n,e,t,o[c+15],22,1236535329),t=m(t,r,n,e,o[c+1],5,-165796510),e=m(e,t,r,n,o[c+6],9,-1069501632),n=m(n,e,t,r,o[c+11],14,643717713),r=m(r,n,e,t,o[c+0],20,-373897302),t=m(t,r,n,e,o[c+5],5,-701558691),e=m(e,t,r,n,o[c+10],9,38016083),n=m(n,e,t,r,o[c+15],14,-660478335),r=m(r,n,e,t,o[c+4],20,-405537848),t=m(t,r,n,e,o[c+9],5,568446438),e=m(e,t,r,n,o[c+14],9,-1019803690),n=m(n,e,t,r,o[c+3],14,-187363961),r=m(r,n,e,t,o[c+8],20,1163531501),t=m(t,r,n,e,o[c+13],5,-1444681467),e=m(e,t,r,n,o[c+2],9,-51403784),n=m(n,e,t,r,o[c+7],14,1735328473),r=m(r,n,e,t,o[c+12],20,-1926607734),t=y(t,r,n,e,o[c+5],4,-378558),e=y(e,t,r,n,o[c+8],11,-2022574463),n=y(n,e,t,r,o[c+11],16,1839030562),r=y(r,n,e,t,o[c+14],23,-35309556),t=y(t,r,n,e,o[c+1],4,-1530992060),e=y(e,t,r,n,o[c+4],11,1272893353),n=y(n,e,t,r,o[c+7],16,-155497632),r=y(r,n,e,t,o[c+10],23,-1094730640),t=y(t,r,n,e,o[c+13],4,681279174),e=y(e,t,r,n,o[c+0],11,-358537222),n=y(n,e,t,r,o[c+3],16,-722521979),r=y(r,n,e,t,o[c+6],23,76029189),t=y(t,r,n,e,o[c+9],4,-640364487),e=y(e,t,r,n,o[c+12],11,-421815835),n=y(n,e,t,r,o[c+15],16,530742520),r=y(r,n,e,t,o[c+2],23,-995338651),t=A(t,r,n,e,o[c+0],6,-198630844),e=A(e,t,r,n,o[c+7],10,1126891415),n=A(n,e,t,r,o[c+14],15,-1416354905),r=A(r,n,e,t,o[c+5],21,-57434055),t=A(t,r,n,e,o[c+12],6,1700485571),e=A(e,t,r,n,o[c+3],10,-1894986606),n=A(n,e,t,r,o[c+10],15,-1051523),r=A(r,n,e,t,o[c+1],21,-2054922799),t=A(t,r,n,e,o[c+8],6,1873313359),e=A(e,t,r,n,o[c+15],10,-30611744),n=A(n,e,t,r,o[c+6],15,-1560198380),r=A(r,n,e,t,o[c+13],21,1309151649),t=A(t,r,n,e,o[c+4],6,-145523070),e=A(e,t,r,n,o[c+11],10,-1120210379),n=A(n,e,t,r,o[c+2],15,718787259),r=A(r,n,e,t,o[c+9],21,-343485551),t=t+_>>>0,r=r+D>>>0,n=n+H>>>0,e=e+j>>>0}return f.endian([t,r,n,e])};u._ff=function(a,l,o,h,t,r,n){var e=a+(l&o|~l&h)+(t>>>0)+n;return(e<<r|e>>>32-r)+l},u._gg=function(a,l,o,h,t,r,n){var e=a+(l&h|o&~h)+(t>>>0)+n;return(e<<r|e>>>32-r)+l},u._hh=function(a,l,o,h,t,r,n){var e=a+(l^o^h)+(t>>>0)+n;return(e<<r|e>>>32-r)+l},u._ii=function(a,l,o,h,t,r,n){var e=a+(o^(l|~h))+(t>>>0)+n;return(e<<r|e>>>32-r)+l},u._blocksize=16,u._digestsize=16,S.exports=function(a,l){if(a==null)throw new Error("Illegal argument "+a);var o=f.wordsToBytes(u(a,l));return l&&l.asBytes?o:l&&l.asString?i.bytesToString(o):f.bytesToHex(o)}})()),S.exports}var P=q(),k=B(P);let F;function E(f){return f?typeof f!="string"?String(f):f.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">"):""}self.onmessage=async f=>{const{type:d,payload:s}=f.data;d==="START_SYNC"&&(F=s.url,await z())};async function z(){try{self.postMessage({type:"PROGRESS",status:"connecting"});const f=await fetch(F);if(!f.ok){const a=await f.text();throw new Error(`HTTP Error ${f.status}: ${a.substring(0,100)}`)}self.postMessage({type:"PROGRESS",status:"downloading"});const d=await f.text(),s=d.trim();if(s.length===0)throw new Error("Server returned empty response");if(s.charAt(0)!=="["&&s.charAt(0)!=="{")throw console.error("CRITICAL: Server returned non-JSON data:",d.substring(0,500)),new Error(`Invalid JSON. Server says: ${d.substring(0,100)}...`);let i;try{i=JSON.parse(d)}catch(a){throw new Error("JSON Parse Error: "+a.message)}if(!Array.isArray(i)){if(i.error)throw new Error("API Error: "+i.error);if(Object.keys(i).length===0)i=[];else throw new Error("Invalid response format: expected JSON array")}self.postMessage({type:"PROGRESS",status:"parsing",count:i.length});const u=i.map(a=>{const l=(a.file||"").normalize("NFC").trim(),o=E(a.title||l.split("/").pop()).normalize("NFC").trim(),h=Array.isArray(a.artist)?a.artist.join(", "):a.artist||"Unknown Artist",t=E(h).normalize("NFC").trim(),r=E(a.album||"Unknown Album").normalize("NFC").trim(),n=Array.isArray(a.genre)?a.genre.join(", "):a.genre||"Unknown",e=E(n).normalize("NFC").trim(),c=a.album_artist||a.albumartist||a.AlbumArtist,g=c?E(c).normalize("NFC").trim():null;let m=null;if(l)try{const A=l.lastIndexOf("/"),_=A===-1?".":l.substring(0,A);m=k(_)}catch{console.warn("Failed to generate thumb hash for",l)}let y=null;return a.encoded_at&&(y=a.encoded_at.replace(/,/g," ").trim()),{file:l,title:o,artist:t,album:r,genre:e,album_artist:g,time:parseFloat(a.time||0),track:parseInt(a.tracknum||0),disc:parseInt(a.disc||1),year:parseInt(a.year||0),encoded_at:a.encoded_at,last_modified:a.last_modified,thumbHash:m,qualityBadge:y}});self.postMessage({type:"PROGRESS",status:"saving",count:u.length}),await N.clear(),await N.bulkAdd(u),self.postMessage({type:"DONE",count:u.length})}catch(f){console.error(f),self.postMessage({type:"ERROR",message:f.message})}}})();
