(function(){"use strict";const h={NAME:"MoodePlayerDB",STORE_NAME:"music",VERSION:2},_={open(){return new Promise((f,d)=>{const o=indexedDB.open(h.NAME,h.VERSION);o.onupgradeneeded=u=>{const l=u.target.result,a=u.target.transaction;let i;l.objectStoreNames.contains(h.STORE_NAME)?i=a.objectStore(h.STORE_NAME):i=l.createObjectStore(h.STORE_NAME,{keyPath:"file"}),i.indexNames.contains("artist")||i.createIndex("artist","artist",{unique:!1}),i.indexNames.contains("album")||i.createIndex("album","album",{unique:!1}),i.indexNames.contains("genre")||i.createIndex("genre","genre",{unique:!1}),i.indexNames.contains("album_artist")||i.createIndex("album_artist","album_artist",{unique:!1})},o.onsuccess=()=>f(o.result),o.onerror=()=>d(o.error)})},async clear(){const f=await this.open();return new Promise((d,o)=>{const u=f.transaction(h.STORE_NAME,"readwrite");u.objectStore(h.STORE_NAME).clear(),u.oncomplete=()=>d(),u.onerror=()=>o(u.error)})},async bulkAdd(f){const d=await this.open();return new Promise((o,u)=>{const l=d.transaction(h.STORE_NAME,"readwrite"),a=l.objectStore(h.STORE_NAME);f.forEach(i=>a.put(i)),l.oncomplete=()=>o(),l.onerror=()=>u(l.error)})},async getFilesMap(f){if(!f||f.length===0)return new Map;const d=await this.open();return new Promise(o=>{const l=d.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME),a=new Map;let i=0;f.forEach(n=>{const p=l.get(n);p.onsuccess=t=>{const r=t.target.result;r&&a.set(n,r),i++,i===f.length&&o(a)},p.onerror=()=>{i++,i===f.length&&o(a)}})})},async getArtists(){const f=await this.open();return new Promise((d,o)=>{const l=f.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME),a=new Map,i=l.openCursor();i.onsuccess=n=>{const p=n.target.result;if(p){const t=p.value,r=t.album_artist||t.artist;r&&!a.has(r)&&a.set(r,{name:r,file:t.file,thumbHash:t.thumbHash}),p.continue()}else{const t=Array.from(a.values()).sort((r,s)=>r.name.localeCompare(s.name,void 0,{sensitivity:"base"}));d(t)}},i.onerror=()=>o(i.error)})},async getAlbums(){const f=await this.open();return new Promise((d,o)=>{const l=f.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME).index("album"),a=[],i=l.openCursor(null,"nextunique");i.onsuccess=n=>{const p=n.target.result;if(p){const t=p.value;a.push({name:t.album,artist:t.album_artist||t.artist,file:t.file,thumbHash:t.thumbHash,qualityBadge:t.qualityBadge,year:t.year||0}),p.continue()}else d(a)},i.onerror=()=>o(i.error)})},async getArtistAlbums(f){if(!f)return[];const d=await this.open();return new Promise((o,u)=>{const a=d.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME),i=new Promise(p=>{a.indexNames.contains("album_artist")?a.index("album_artist").getAll(IDBKeyRange.only(f)).onsuccess=t=>p(t.target.result):p([])}),n=new Promise(p=>{a.index("artist").getAll(IDBKeyRange.only(f)).onsuccess=t=>p(t.target.result)});Promise.all([i,n]).then(([p,t])=>{const r=[...p,...t],s=[],e=new Set;r.forEach(c=>{e.has(c.album)||(e.add(c.album),s.push({name:c.album,artist:c.album_artist||c.artist,file:c.file,thumbHash:c.thumbHash,qualityBadge:c.qualityBadge,year:c.year||0}))}),o(s)}).catch(p=>u(p))})},async getAlbumTracks(f){const d=await this.open();return new Promise((o,u)=>{const a=d.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME).index("album"),i=IDBKeyRange.only(f),n=a.getAll(i);n.onsuccess=()=>{const p=n.result;p.sort((t,r)=>{const s=parseInt(t.disc||1),e=parseInt(r.disc||1);if(s!==e)return s-e;const c=parseInt(t.track||0),g=parseInt(r.track||0);return c-g}),o(p)},n.onerror=()=>u(n.error)})},async getGenres(){const f=await this.open();return new Promise((d,o)=>{const l=f.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME).index("genre"),a=[],i=l.openKeyCursor(null,"nextunique");i.onsuccess=n=>{const p=n.target.result;p?(a.push(p.key),p.continue()):d(a)},i.onerror=()=>o(i.error)})},async getGenreTracks(f){const d=await this.open();return new Promise((o,u)=>{const i=d.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME).index("genre").getAll(IDBKeyRange.only(f));i.onsuccess=()=>o(i.result),i.onerror=()=>u(i.error)})},async search(f){if(!f)return[];const d=f.toLowerCase(),o=await this.open();return new Promise((u,l)=>{const i=o.transaction(h.STORE_NAME,"readonly").objectStore(h.STORE_NAME),n=[],p=100,t=i.openCursor();t.onsuccess=r=>{const s=r.target.result;if(s){const e=s.value;if((e.title&&e.title.toLowerCase().includes(d)||e.artist&&e.artist.toLowerCase().includes(d)||e.album&&e.album.toLowerCase().includes(d)||e.album_artist&&e.album_artist.toLowerCase().includes(d))&&n.push(e),n.length>=p){u(n);return}s.continue()}else u(n)},t.onerror=()=>l(t.error)})}};function B(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}var w={exports:{}},x={exports:{}},T;function I(){return T||(T=1,(function(){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d={rotl:function(o,u){return o<<u|o>>>32-u},rotr:function(o,u){return o<<32-u|o>>>u},endian:function(o){if(o.constructor==Number)return d.rotl(o,8)&16711935|d.rotl(o,24)&4278255360;for(var u=0;u<o.length;u++)o[u]=d.endian(o[u]);return o},randomBytes:function(o){for(var u=[];o>0;o--)u.push(Math.floor(Math.random()*256));return u},bytesToWords:function(o){for(var u=[],l=0,a=0;l<o.length;l++,a+=8)u[a>>>5]|=o[l]<<24-a%32;return u},wordsToBytes:function(o){for(var u=[],l=0;l<o.length*32;l+=8)u.push(o[l>>>5]>>>24-l%32&255);return u},bytesToHex:function(o){for(var u=[],l=0;l<o.length;l++)u.push((o[l]>>>4).toString(16)),u.push((o[l]&15).toString(16));return u.join("")},hexToBytes:function(o){for(var u=[],l=0;l<o.length;l+=2)u.push(parseInt(o.substr(l,2),16));return u},bytesToBase64:function(o){for(var u=[],l=0;l<o.length;l+=3)for(var a=o[l]<<16|o[l+1]<<8|o[l+2],i=0;i<4;i++)l*8+i*6<=o.length*8?u.push(f.charAt(a>>>6*(3-i)&63)):u.push("=");return u.join("")},base64ToBytes:function(o){o=o.replace(/[^A-Z0-9+\/]/ig,"");for(var u=[],l=0,a=0;l<o.length;a=++l%4)a!=0&&u.push((f.indexOf(o.charAt(l-1))&Math.pow(2,-2*a+8)-1)<<a*2|f.indexOf(o.charAt(l))>>>6-a*2);return u}};x.exports=d})()),x.exports}var m,R;function M(){if(R)return m;R=1;var f={utf8:{stringToBytes:function(d){return f.bin.stringToBytes(unescape(encodeURIComponent(d)))},bytesToString:function(d){return decodeURIComponent(escape(f.bin.bytesToString(d)))}},bin:{stringToBytes:function(d){for(var o=[],u=0;u<d.length;u++)o.push(d.charCodeAt(u)&255);return o},bytesToString:function(d){for(var o=[],u=0;u<d.length;u++)o.push(String.fromCharCode(d[u]));return o.join("")}}};return m=f,m}var b,v;function q(){if(v)return b;v=1,b=function(o){return o!=null&&(f(o)||d(o)||!!o._isBuffer)};function f(o){return!!o.constructor&&typeof o.constructor.isBuffer=="function"&&o.constructor.isBuffer(o)}function d(o){return typeof o.readFloatLE=="function"&&typeof o.slice=="function"&&f(o.slice(0,0))}return b}var O;function F(){return O||(O=1,(function(){var f=I(),d=M().utf8,o=q(),u=M().bin,l=function(a,i){a.constructor==String?i&&i.encoding==="binary"?a=u.stringToBytes(a):a=d.stringToBytes(a):o(a)?a=Array.prototype.slice.call(a,0):!Array.isArray(a)&&a.constructor!==Uint8Array&&(a=a.toString());for(var n=f.bytesToWords(a),p=a.length*8,t=1732584193,r=-271733879,s=-1732584194,e=271733878,c=0;c<n.length;c++)n[c]=(n[c]<<8|n[c]>>>24)&16711935|(n[c]<<24|n[c]>>>8)&4278255360;n[p>>>5]|=128<<p%32,n[(p+64>>>9<<4)+14]=p;for(var g=l._ff,y=l._gg,E=l._hh,S=l._ii,c=0;c<n.length;c+=16){var H=t,D=r,j=s,G=e;t=g(t,r,s,e,n[c+0],7,-680876936),e=g(e,t,r,s,n[c+1],12,-389564586),s=g(s,e,t,r,n[c+2],17,606105819),r=g(r,s,e,t,n[c+3],22,-1044525330),t=g(t,r,s,e,n[c+4],7,-176418897),e=g(e,t,r,s,n[c+5],12,1200080426),s=g(s,e,t,r,n[c+6],17,-1473231341),r=g(r,s,e,t,n[c+7],22,-45705983),t=g(t,r,s,e,n[c+8],7,1770035416),e=g(e,t,r,s,n[c+9],12,-1958414417),s=g(s,e,t,r,n[c+10],17,-42063),r=g(r,s,e,t,n[c+11],22,-1990404162),t=g(t,r,s,e,n[c+12],7,1804603682),e=g(e,t,r,s,n[c+13],12,-40341101),s=g(s,e,t,r,n[c+14],17,-1502002290),r=g(r,s,e,t,n[c+15],22,1236535329),t=y(t,r,s,e,n[c+1],5,-165796510),e=y(e,t,r,s,n[c+6],9,-1069501632),s=y(s,e,t,r,n[c+11],14,643717713),r=y(r,s,e,t,n[c+0],20,-373897302),t=y(t,r,s,e,n[c+5],5,-701558691),e=y(e,t,r,s,n[c+10],9,38016083),s=y(s,e,t,r,n[c+15],14,-660478335),r=y(r,s,e,t,n[c+4],20,-405537848),t=y(t,r,s,e,n[c+9],5,568446438),e=y(e,t,r,s,n[c+14],9,-1019803690),s=y(s,e,t,r,n[c+3],14,-187363961),r=y(r,s,e,t,n[c+8],20,1163531501),t=y(t,r,s,e,n[c+13],5,-1444681467),e=y(e,t,r,s,n[c+2],9,-51403784),s=y(s,e,t,r,n[c+7],14,1735328473),r=y(r,s,e,t,n[c+12],20,-1926607734),t=E(t,r,s,e,n[c+5],4,-378558),e=E(e,t,r,s,n[c+8],11,-2022574463),s=E(s,e,t,r,n[c+11],16,1839030562),r=E(r,s,e,t,n[c+14],23,-35309556),t=E(t,r,s,e,n[c+1],4,-1530992060),e=E(e,t,r,s,n[c+4],11,1272893353),s=E(s,e,t,r,n[c+7],16,-155497632),r=E(r,s,e,t,n[c+10],23,-1094730640),t=E(t,r,s,e,n[c+13],4,681279174),e=E(e,t,r,s,n[c+0],11,-358537222),s=E(s,e,t,r,n[c+3],16,-722521979),r=E(r,s,e,t,n[c+6],23,76029189),t=E(t,r,s,e,n[c+9],4,-640364487),e=E(e,t,r,s,n[c+12],11,-421815835),s=E(s,e,t,r,n[c+15],16,530742520),r=E(r,s,e,t,n[c+2],23,-995338651),t=S(t,r,s,e,n[c+0],6,-198630844),e=S(e,t,r,s,n[c+7],10,1126891415),s=S(s,e,t,r,n[c+14],15,-1416354905),r=S(r,s,e,t,n[c+5],21,-57434055),t=S(t,r,s,e,n[c+12],6,1700485571),e=S(e,t,r,s,n[c+3],10,-1894986606),s=S(s,e,t,r,n[c+10],15,-1051523),r=S(r,s,e,t,n[c+1],21,-2054922799),t=S(t,r,s,e,n[c+8],6,1873313359),e=S(e,t,r,s,n[c+15],10,-30611744),s=S(s,e,t,r,n[c+6],15,-1560198380),r=S(r,s,e,t,n[c+13],21,1309151649),t=S(t,r,s,e,n[c+4],6,-145523070),e=S(e,t,r,s,n[c+11],10,-1120210379),s=S(s,e,t,r,n[c+2],15,718787259),r=S(r,s,e,t,n[c+9],21,-343485551),t=t+H>>>0,r=r+D>>>0,s=s+j>>>0,e=e+G>>>0}return f.endian([t,r,s,e])};l._ff=function(a,i,n,p,t,r,s){var e=a+(i&n|~i&p)+(t>>>0)+s;return(e<<r|e>>>32-r)+i},l._gg=function(a,i,n,p,t,r,s){var e=a+(i&p|n&~p)+(t>>>0)+s;return(e<<r|e>>>32-r)+i},l._hh=function(a,i,n,p,t,r,s){var e=a+(i^n^p)+(t>>>0)+s;return(e<<r|e>>>32-r)+i},l._ii=function(a,i,n,p,t,r,s){var e=a+(n^(i|~p))+(t>>>0)+s;return(e<<r|e>>>32-r)+i},l._blocksize=16,l._digestsize=16,w.exports=function(a,i){if(a==null)throw new Error("Illegal argument "+a);var n=f.wordsToBytes(l(a,i));return i&&i.asBytes?n:i&&i.asString?u.bytesToString(n):f.bytesToHex(n)}})()),w.exports}var P=F(),C=B(P);let N;function A(f){return f?typeof f!="string"?String(f):f.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">"):""}self.onmessage=async f=>{const{type:d,payload:o}=f.data;d==="START_SYNC"&&(N=o.url,await k())};async function k(){try{self.postMessage({type:"PROGRESS",status:"connecting"});const f=await fetch(N);if(!f.ok){const a=await f.text();throw new Error(`HTTP Error ${f.status}: ${a.substring(0,100)}`)}self.postMessage({type:"PROGRESS",status:"downloading"});const d=await f.text(),o=d.trim();if(o.length===0)throw new Error("Server returned empty response");if(o.charAt(0)!=="["&&o.charAt(0)!=="{")throw console.error("CRITICAL: Server returned non-JSON data:",d.substring(0,500)),new Error(`Invalid JSON. Server says: ${d.substring(0,100)}...`);let u;try{u=JSON.parse(d)}catch(a){throw new Error("JSON Parse Error: "+a.message)}if(!Array.isArray(u)){if(u.error)throw new Error("API Error: "+u.error);if(Object.keys(u).length===0)u=[];else throw new Error("Invalid response format: expected JSON array")}self.postMessage({type:"PROGRESS",status:"parsing",count:u.length});const l=u.map(a=>{let i=null;if(a.file)try{const s=a.file.lastIndexOf("/"),e=s===-1?".":a.file.substring(0,s);i=C(e)}catch{console.warn("Failed to generate thumb hash for",a.file)}const n=Array.isArray(a.artist)?a.artist.join(", "):a.artist,p=Array.isArray(a.genre)?a.genre.join(", "):a.genre,t=a.album_artist||a.albumartist||a.AlbumArtist;let r=null;return a.encoded_at&&(r=a.encoded_at.replace(/,/g," ").trim()),{file:a.file,title:A(a.title||a.file.split("/").pop()),artist:A(n||"Unknown Artist"),album:A(a.album||"Unknown Album"),genre:A(p||"Unknown"),album_artist:t?A(t):null,time:parseFloat(a.time||0),track:parseInt(a.tracknum||0),disc:parseInt(a.disc||1),year:parseInt(a.year||0),encoded_at:a.encoded_at,last_modified:a.last_modified,thumbHash:i,qualityBadge:r}});self.postMessage({type:"PROGRESS",status:"saving",count:l.length}),await _.clear(),await _.bulkAdd(l),self.postMessage({type:"DONE",count:l.length})}catch(f){console.error(f),self.postMessage({type:"ERROR",message:f.message})}}})();
