(function(){"use strict";const p={NAME:"MoodePlayerDB",STORE_NAME:"music",VERSION:2},b={open(){return new Promise((f,d)=>{const o=indexedDB.open(p.NAME,p.VERSION);o.onupgradeneeded=u=>{const l=u.target.result,a=u.target.transaction;let i;l.objectStoreNames.contains(p.STORE_NAME)?i=a.objectStore(p.STORE_NAME):i=l.createObjectStore(p.STORE_NAME,{keyPath:"file"}),i.indexNames.contains("artist")||i.createIndex("artist","artist",{unique:!1}),i.indexNames.contains("album")||i.createIndex("album","album",{unique:!1}),i.indexNames.contains("genre")||i.createIndex("genre","genre",{unique:!1}),i.indexNames.contains("album_artist")||i.createIndex("album_artist","album_artist",{unique:!1})},o.onsuccess=()=>f(o.result),o.onerror=()=>d(o.error)})},async clear(){const f=await this.open();return new Promise((d,o)=>{const u=f.transaction(p.STORE_NAME,"readwrite");u.objectStore(p.STORE_NAME).clear(),u.oncomplete=()=>d(),u.onerror=()=>o(u.error)})},async bulkAdd(f){const d=await this.open();return new Promise((o,u)=>{const l=d.transaction(p.STORE_NAME,"readwrite"),a=l.objectStore(p.STORE_NAME);f.forEach(i=>{a.put(i)}),l.oncomplete=()=>o(),l.onerror=()=>u(l.error)})},async getArtists(){const f=await this.open();return new Promise((d,o)=>{const l=f.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME),a=new Map,i=l.openCursor();i.onsuccess=s=>{const h=s.target.result;if(h){const r=h.value,t=r.album_artist||r.artist;t&&!a.has(t)&&a.set(t,{name:t,file:r.file,cachedThumbUrl:r.cachedThumbUrl}),h.continue()}else{const r=Array.from(a.values()).sort((t,n)=>t.name.localeCompare(n.name,void 0,{sensitivity:"base"}));d(r)}},i.onerror=()=>o(i.error)})},async getAlbums(){const f=await this.open();return new Promise((d,o)=>{const l=f.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("album"),a=[],i=l.openCursor(null,"nextunique");i.onsuccess=s=>{const h=s.target.result;if(h){const r=h.value;a.push({name:r.album,artist:r.album_artist||r.artist,file:r.file,cachedThumbUrl:r.cachedThumbUrl}),h.continue()}else d(a)},i.onerror=()=>o(i.error)})},async getArtistAlbums(f){if(!f)return[];const d=await this.open();return new Promise((o,u)=>{const a=d.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME),i=new Promise(h=>{a.indexNames.contains("album_artist")?a.index("album_artist").getAll(IDBKeyRange.only(f)).onsuccess=r=>h(r.target.result):h([])}),s=new Promise(h=>{a.index("artist").getAll(IDBKeyRange.only(f)).onsuccess=r=>h(r.target.result)});Promise.all([i,s]).then(([h,r])=>{const t=[...h,...r],n=[],e=new Set;t.forEach(c=>{e.has(c.album)||(e.add(c.album),n.push({name:c.album,artist:c.album_artist||c.artist,file:c.file,cachedThumbUrl:c.cachedThumbUrl}))}),o(n)}).catch(h=>u(h))})},async getAlbumTracks(f){const d=await this.open();return new Promise((o,u)=>{const a=d.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("album"),i=IDBKeyRange.only(f),s=a.getAll(i);s.onsuccess=()=>{const h=s.result;h.sort((r,t)=>{const n=parseInt(r.disc||1),e=parseInt(t.disc||1);if(n!==e)return n-e;const c=parseInt(r.track||0),g=parseInt(t.track||0);return c-g}),o(h)},s.onerror=()=>u(s.error)})},async getGenres(){const f=await this.open();return new Promise((d,o)=>{const l=f.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("genre"),a=[],i=l.openKeyCursor(null,"nextunique");i.onsuccess=s=>{const h=s.target.result;h?(a.push(h.key),h.continue()):d(a)},i.onerror=()=>o(i.error)})},async getGenreTracks(f){const d=await this.open();return new Promise((o,u)=>{const i=d.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME).index("genre").getAll(IDBKeyRange.only(f));i.onsuccess=()=>o(i.result),i.onerror=()=>u(i.error)})},async search(f){if(!f)return[];const d=f.toLowerCase(),o=await this.open();return new Promise((u,l)=>{const i=o.transaction(p.STORE_NAME,"readonly").objectStore(p.STORE_NAME),s=[],h=100,r=i.openCursor();r.onsuccess=t=>{const n=t.target.result;if(n){const e=n.value;if((e.title&&e.title.toLowerCase().includes(d)||e.artist&&e.artist.toLowerCase().includes(d)||e.album&&e.album.toLowerCase().includes(d)||e.album_artist&&e.album_artist.toLowerCase().includes(d))&&s.push(e),s.length>=h){u(s);return}n.continue()}else u(s)},r.onerror=()=>l(r.error)})}};function I(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}var m={exports:{}},w={exports:{}},_;function B(){return _||(_=1,(function(){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d={rotl:function(o,u){return o<<u|o>>>32-u},rotr:function(o,u){return o<<32-u|o>>>u},endian:function(o){if(o.constructor==Number)return d.rotl(o,8)&16711935|d.rotl(o,24)&4278255360;for(var u=0;u<o.length;u++)o[u]=d.endian(o[u]);return o},randomBytes:function(o){for(var u=[];o>0;o--)u.push(Math.floor(Math.random()*256));return u},bytesToWords:function(o){for(var u=[],l=0,a=0;l<o.length;l++,a+=8)u[a>>>5]|=o[l]<<24-a%32;return u},wordsToBytes:function(o){for(var u=[],l=0;l<o.length*32;l+=8)u.push(o[l>>>5]>>>24-l%32&255);return u},bytesToHex:function(o){for(var u=[],l=0;l<o.length;l++)u.push((o[l]>>>4).toString(16)),u.push((o[l]&15).toString(16));return u.join("")},hexToBytes:function(o){for(var u=[],l=0;l<o.length;l+=2)u.push(parseInt(o.substr(l,2),16));return u},bytesToBase64:function(o){for(var u=[],l=0;l<o.length;l+=3)for(var a=o[l]<<16|o[l+1]<<8|o[l+2],i=0;i<4;i++)l*8+i*6<=o.length*8?u.push(f.charAt(a>>>6*(3-i)&63)):u.push("=");return u.join("")},base64ToBytes:function(o){o=o.replace(/[^A-Z0-9+\/]/ig,"");for(var u=[],l=0,a=0;l<o.length;a=++l%4)a!=0&&u.push((f.indexOf(o.charAt(l-1))&Math.pow(2,-2*a+8)-1)<<a*2|f.indexOf(o.charAt(l))>>>6-a*2);return u}};w.exports=d})()),w.exports}var x,R;function v(){if(R)return x;R=1;var f={utf8:{stringToBytes:function(d){return f.bin.stringToBytes(unescape(encodeURIComponent(d)))},bytesToString:function(d){return decodeURIComponent(escape(f.bin.bytesToString(d)))}},bin:{stringToBytes:function(d){for(var o=[],u=0;u<d.length;u++)o.push(d.charCodeAt(u)&255);return o},bytesToString:function(d){for(var o=[],u=0;u<d.length;u++)o.push(String.fromCharCode(d[u]));return o.join("")}}};return x=f,x}var T,O;function F(){if(O)return T;O=1,T=function(o){return o!=null&&(f(o)||d(o)||!!o._isBuffer)};function f(o){return!!o.constructor&&typeof o.constructor.isBuffer=="function"&&o.constructor.isBuffer(o)}function d(o){return typeof o.readFloatLE=="function"&&typeof o.slice=="function"&&f(o.slice(0,0))}return T}var M;function q(){return M||(M=1,(function(){var f=B(),d=v().utf8,o=F(),u=v().bin,l=function(a,i){a.constructor==String?i&&i.encoding==="binary"?a=u.stringToBytes(a):a=d.stringToBytes(a):o(a)?a=Array.prototype.slice.call(a,0):!Array.isArray(a)&&a.constructor!==Uint8Array&&(a=a.toString());for(var s=f.bytesToWords(a),h=a.length*8,r=1732584193,t=-271733879,n=-1732584194,e=271733878,c=0;c<s.length;c++)s[c]=(s[c]<<8|s[c]>>>24)&16711935|(s[c]<<24|s[c]>>>8)&4278255360;s[h>>>5]|=128<<h%32,s[(h+64>>>9<<4)+14]=h;for(var g=l._ff,y=l._gg,E=l._hh,S=l._ii,c=0;c<s.length;c+=16){var U=r,D=t,j=n,G=e;r=g(r,t,n,e,s[c+0],7,-680876936),e=g(e,r,t,n,s[c+1],12,-389564586),n=g(n,e,r,t,s[c+2],17,606105819),t=g(t,n,e,r,s[c+3],22,-1044525330),r=g(r,t,n,e,s[c+4],7,-176418897),e=g(e,r,t,n,s[c+5],12,1200080426),n=g(n,e,r,t,s[c+6],17,-1473231341),t=g(t,n,e,r,s[c+7],22,-45705983),r=g(r,t,n,e,s[c+8],7,1770035416),e=g(e,r,t,n,s[c+9],12,-1958414417),n=g(n,e,r,t,s[c+10],17,-42063),t=g(t,n,e,r,s[c+11],22,-1990404162),r=g(r,t,n,e,s[c+12],7,1804603682),e=g(e,r,t,n,s[c+13],12,-40341101),n=g(n,e,r,t,s[c+14],17,-1502002290),t=g(t,n,e,r,s[c+15],22,1236535329),r=y(r,t,n,e,s[c+1],5,-165796510),e=y(e,r,t,n,s[c+6],9,-1069501632),n=y(n,e,r,t,s[c+11],14,643717713),t=y(t,n,e,r,s[c+0],20,-373897302),r=y(r,t,n,e,s[c+5],5,-701558691),e=y(e,r,t,n,s[c+10],9,38016083),n=y(n,e,r,t,s[c+15],14,-660478335),t=y(t,n,e,r,s[c+4],20,-405537848),r=y(r,t,n,e,s[c+9],5,568446438),e=y(e,r,t,n,s[c+14],9,-1019803690),n=y(n,e,r,t,s[c+3],14,-187363961),t=y(t,n,e,r,s[c+8],20,1163531501),r=y(r,t,n,e,s[c+13],5,-1444681467),e=y(e,r,t,n,s[c+2],9,-51403784),n=y(n,e,r,t,s[c+7],14,1735328473),t=y(t,n,e,r,s[c+12],20,-1926607734),r=E(r,t,n,e,s[c+5],4,-378558),e=E(e,r,t,n,s[c+8],11,-2022574463),n=E(n,e,r,t,s[c+11],16,1839030562),t=E(t,n,e,r,s[c+14],23,-35309556),r=E(r,t,n,e,s[c+1],4,-1530992060),e=E(e,r,t,n,s[c+4],11,1272893353),n=E(n,e,r,t,s[c+7],16,-155497632),t=E(t,n,e,r,s[c+10],23,-1094730640),r=E(r,t,n,e,s[c+13],4,681279174),e=E(e,r,t,n,s[c+0],11,-358537222),n=E(n,e,r,t,s[c+3],16,-722521979),t=E(t,n,e,r,s[c+6],23,76029189),r=E(r,t,n,e,s[c+9],4,-640364487),e=E(e,r,t,n,s[c+12],11,-421815835),n=E(n,e,r,t,s[c+15],16,530742520),t=E(t,n,e,r,s[c+2],23,-995338651),r=S(r,t,n,e,s[c+0],6,-198630844),e=S(e,r,t,n,s[c+7],10,1126891415),n=S(n,e,r,t,s[c+14],15,-1416354905),t=S(t,n,e,r,s[c+5],21,-57434055),r=S(r,t,n,e,s[c+12],6,1700485571),e=S(e,r,t,n,s[c+3],10,-1894986606),n=S(n,e,r,t,s[c+10],15,-1051523),t=S(t,n,e,r,s[c+1],21,-2054922799),r=S(r,t,n,e,s[c+8],6,1873313359),e=S(e,r,t,n,s[c+15],10,-30611744),n=S(n,e,r,t,s[c+6],15,-1560198380),t=S(t,n,e,r,s[c+13],21,1309151649),r=S(r,t,n,e,s[c+4],6,-145523070),e=S(e,r,t,n,s[c+11],10,-1120210379),n=S(n,e,r,t,s[c+2],15,718787259),t=S(t,n,e,r,s[c+9],21,-343485551),r=r+U>>>0,t=t+D>>>0,n=n+j>>>0,e=e+G>>>0}return f.endian([r,t,n,e])};l._ff=function(a,i,s,h,r,t,n){var e=a+(i&s|~i&h)+(r>>>0)+n;return(e<<t|e>>>32-t)+i},l._gg=function(a,i,s,h,r,t,n){var e=a+(i&h|s&~h)+(r>>>0)+n;return(e<<t|e>>>32-t)+i},l._hh=function(a,i,s,h,r,t,n){var e=a+(i^s^h)+(r>>>0)+n;return(e<<t|e>>>32-t)+i},l._ii=function(a,i,s,h,r,t,n){var e=a+(s^(i|~h))+(r>>>0)+n;return(e<<t|e>>>32-t)+i},l._blocksize=16,l._digestsize=16,m.exports=function(a,i){if(a==null)throw new Error("Illegal argument "+a);var s=f.wordsToBytes(l(a,i));return i&&i.asBytes?s:i&&i.asString?u.bytesToString(s):f.bytesToHex(s)}})()),m.exports}var P=q(),C=I(P);let N;function A(f){return f?typeof f!="string"?String(f):f.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">"):""}self.onmessage=async f=>{const{type:d,payload:o}=f.data;d==="START_SYNC"&&(N=o.url,await k())};async function k(){try{self.postMessage({type:"PROGRESS",status:"connecting"});const f=await fetch(N);if(!f.ok){const a=await f.text();throw new Error(`HTTP Error ${f.status}: ${a.substring(0,100)}`)}self.postMessage({type:"PROGRESS",status:"downloading"});const d=await f.text(),o=d.trim();if(o.length===0)throw new Error("Server returned empty response");if(o.charAt(0)!=="["&&o.charAt(0)!=="{")throw console.error("CRITICAL: Server returned non-JSON data:",d.substring(0,500)),new Error(`Invalid JSON. Server says: ${d.substring(0,100)}...`);let u;try{u=JSON.parse(d)}catch(a){throw new Error("JSON Parse Error: "+a.message)}if(!Array.isArray(u)){if(u.error)throw new Error("API Error: "+u.error);if(Object.keys(u).length===0)u=[];else throw new Error("Invalid response format: expected JSON array")}self.postMessage({type:"PROGRESS",status:"parsing",count:u.length});const l=u.map(a=>{let i=null;if(a.file)try{const t=a.file.lastIndexOf("/"),n=t===-1?".":a.file.substring(0,t);i=`/imagesw/thmcache/${C(n)}_sm.jpg`}catch{console.warn("Failed to generate thumb hash for",a.file)}const s=Array.isArray(a.artist)?a.artist.join(", "):a.artist,h=Array.isArray(a.genre)?a.genre.join(", "):a.genre,r=a.album_artist||a.albumartist||a.AlbumArtist;return{file:a.file,title:A(a.title||a.file.split("/").pop()),artist:A(s||"Unknown Artist"),album:A(a.album||"Unknown Album"),genre:A(h||"Unknown"),album_artist:r?A(r):null,time:parseFloat(a.time||0),track:parseInt(a.tracknum||0),disc:parseInt(a.disc||1),year:parseInt(a.year||0),encoded_at:a.encoded_at,last_modified:a.last_modified,cachedThumbUrl:i}});self.postMessage({type:"PROGRESS",status:"saving",count:l.length}),await b.clear(),await b.bulkAdd(l),self.postMessage({type:"DONE",count:l.length})}catch(f){console.error(f),self.postMessage({type:"ERROR",message:f.message})}}})();
